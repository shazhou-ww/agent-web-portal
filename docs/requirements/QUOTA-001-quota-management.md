# QUOTA-001: 配额管理

> 优先级：P0 - 必须完成

## 背景

目前用户可以无限上传数据，没有使用量统计和限制机制。生产环境需要：

- 防止资源滥用
- 成本控制
- 公平使用

## 需求

实现存储配额管理，包括用量统计和限制。

## 设计问题

### 1. 计量单位

| 选项 | 说明 |
|------|------|
| 存储字节数 | 最直观，用户易理解 |
| 节点数量 | 简单计数，但不反映实际占用 |
| 两者都要 | 更全面，但更复杂 |

**待决定**：主要计量单位。

### 2. 去重如何计算

CAS 的核心特性是去重。同一个 chunk 被多个 file 引用时：

| 选项 | 说明 | 优点 | 缺点 |
|------|------|------|------|
| 按实际占用 | 只算一份 | 反映真实成本 | 用户难理解，跨 realm 共享复杂 |
| 按逻辑占用 | 每个引用都算 | 简单，用户直观 | 不反映真实存储 |
| 混合 | 显示两个数字 | 透明 | 复杂 |

**待决定**：去重场景的计算方式。

### 3. 统计时机

| 选项 | 说明 |
|------|------|
| 写入时实时统计 | 准确，但增加写入开销 |
| 定时扫描 | 简单，但有延迟 |
| 事件驱动 | commit 时更新 |

**待决定**：统计更新策略。

### 4. GC 后更新

GC 删除节点后，需要同步更新用量统计。

**待决定**：与 GC 的集成方式。

### 5. 配额来源

| 选项 | 说明 |
|------|------|
| 全局默认值 | 所有用户一样 |
| 用户等级 | 不同等级不同配额 |
| 动态配置 | 可针对单个用户调整 |

**待决定**：配额配置模型。

### 6. 超额处理

| 选项 | 说明 |
|------|------|
| 硬限制 | 超额拒绝写入 |
| 软限制 | 警告但允许一定超额 |
| 降级 | 超额后限制功能 |

**待决定**：超额处理策略。

### 7. 限流（可选）

除了存储配额，是否需要：

- QPS 限制
- 带宽限制
- 并发连接数限制

**待决定**：是否需要限流，以及限流策略。

## 数据模型（草案）

```typescript
interface RealmQuota {
  realm: string;
  
  // 配额限制
  storageLimit: number;      // 字节
  nodeCountLimit?: number;   // 节点数（可选）
  
  // 当前用量
  storageUsed: number;
  nodeCount: number;
  
  // 统计时间
  lastUpdatedAt: number;
}
```

## API 设计（草案）

```typescript
// 用户查看自己的配额
GET /realm/@me/quota
// Response: { limit: number, used: number, ... }

// 管理员调整配额
PUT /admin/users/:userId/quota
// Body: { storageLimit: number }
```

## 验收标准

- [ ] 能查看当前用量和配额
- [ ] 写入时检查配额，超额拒绝
- [ ] GC 后用量正确更新
- [ ] 管理员能调整用户配额
- [ ] 有用量变化日志

## 决策记录

| 日期 | 决策 | 原因 |
|------|------|------|
| - | - | - |
